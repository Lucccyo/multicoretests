;; test of ws_deque from domainslib

(executable
 (name ws_deque_test)
 (modules ws_deque_test)
 (libraries util qcheck STM domainslib)
 (preprocess (pps ppx_deriving.show)))

(env
 (_
  (binaries
   (../check_error_count.exe as check_error_count))))

(rule
 (alias runtest)
 (deps ws_deque_test.exe %{bin:check_error_count})
 (action
   (progn
    (with-accepted-exit-codes 1
      (with-stdout-to "wsd-output.txt" (run ./ws_deque_test.exe --no-colors --verbose)))
    (cat wsd-output.txt)
    (run %{bin:check_error_count} "ws_deque_test" 1 wsd-output.txt))))


;; tests of Domainslib.Task's async functionality (non-STM)

(executable
 (name task_one_dep)
 (modes native byte)
 (modules task_one_dep)
 (libraries util qcheck domainslib)
 (preprocess (pps ppx_deriving.show)))

(rule
 (alias runtest)
 (deps task_one_dep.exe)
 (action (run ./%{deps} --no-colors --verbose)))

(executable
 (name task_more_deps)
 (modes native byte)
 (modules task_more_deps)
 (libraries util qcheck domainslib)
 (preprocess (pps ppx_deriving.show)))

(rule
 (alias runtest)
 (deps task_more_deps.exe)
 (action (run ./%{deps} --no-colors --verbose)))

(executable
 (name task_parallel)
 (modes native byte)
 (modules task_parallel)
 (libraries util qcheck domainslib))

(rule
 (alias runtest)
 (deps task_parallel.exe)
 (action (run ./%{deps} --no-colors --verbose)))
